<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI DRONE LAB ¬∑ v1.21.1</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#0f0f0f;
      --text:#eaeaea;
      --muted:#7a7a7a;
      --line:#1f1f1f;

      /* Default = neutral (nicht neon) */
      --accent:#bdbdbd;

      --warn:#ff4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--mono);
      letter-spacing:.2px;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: 1100px; margin:0 auto; padding: 22px 14px 70px; }
    .topbar{
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--line); padding-bottom:12px; margin-bottom:14px;
    }
    .title{ font-size:16px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:6px; }
    .tag{ display:inline-block; border:1px solid var(--line); padding:3px 6px; font-size:11px; color:var(--muted); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }

    .panel{ background:var(--panel); border:1px solid var(--line); padding:13px; }
    .panel h2{
      margin:0 0 10px; font-size:13px; color:var(--accent); font-weight:600; letter-spacing:.6px;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width: 720px){ .stats{ grid-template-columns: 1fr 1fr; } }
    .stat{ border:1px solid var(--line); padding:10px; background:#0b0b0b; }
    .k{ color:var(--muted); font-size:11px; margin-bottom:6px; }
    .v{ font-size:16px; }
    .v small{ color:var(--muted); font-size:12px; }

    .buttons{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      appearance:none; background:transparent; color:var(--text);
      border:1px solid var(--line);
      padding:10px 12px; cursor:pointer; font-family:var(--mono);
      font-size:12px; letter-spacing:.3px;
      user-select:none;
    }
    button:hover{ border-color:var(--accent); color:var(--accent); }
    button:disabled{ opacity:.45; cursor:not-allowed; color:var(--muted); border-color:var(--line); }

    .hint{ color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35; }

    .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .item{ border:1px solid var(--line); background:#0b0b0b; padding:10px; }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .itemName{ font-size:12px; }
    .itemMeta{ font-size:11px; color:var(--muted); }
    .itemBtns{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .mini{ padding:7px 10px; font-size:11px; }

    .monoBox{
      border:1px solid var(--line);
      background:#050505;
      padding:10px;
      font-size:12px;
      white-space:pre-wrap;
      max-height:220px;
      overflow:auto;
    }
    .ok{ color:var(--accent); }
    .bad{ color:var(--warn); }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){ .twoCols{ grid-template-columns:1fr; } }

    /* Hangar visuals */
    .hangar{
      border:1px solid var(--line);
      background:#050505;
      padding:10px;
      min-height:120px;
    }
    .hangarRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px dashed #141414; padding:7px 0;
    }
    .hangarRow:last-child{ border-bottom:none; }
    .hangarLeft{ display:flex; gap:10px; align-items:center; }
    .icon{
      width:22px; height:22px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--line);
      color:var(--accent);
      font-size:12px;
    }
    .count{ color:var(--muted); font-size:12px; }
    .bar{
      height:6px; border:1px solid var(--line); background:#060606;
      overflow:hidden; width:160px;
    }
    .bar > div{ height:100%; background:var(--accent); width:0%; }
    @media (max-width: 420px){ .bar{ width:120px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">
            AI DRONE LAB <span class="tag">v1.22</span>
            <span id="vipBadge" style="margin-left:8px;color:gold;display:none;">‚òÖ VIP</span>
          </div>
        <div class="sub">Cookie-Clicker style ¬∑ Coins + Drohnen-Producer ¬∑ RP-Tech ¬∑ Cosmetics</div>
      </div>
      <div class="sub">
        <span class="tag" id="statusTag">autosave: ON</span>
        <a href="/">home</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Core -->
      <div class="panel">
        <h2>STATUS</h2>
        <div class="stats">
          <div class="stat"><div class="k">Coins</div><div class="v"><span id="coins">0</span> <small>CP</small></div></div>
          <div class="stat"><div class="k">Coins / sec</div><div class="v"><span id="cps">0</span> <small>CP/s</small></div></div>
          <div class="stat"><div class="k">Click Power</div><div class="v"><span id="clickPow">1</span> <small>CP</small></div></div>
          <div class="stat"><div class="k">Research</div><div class="v"><span id="rp">0</span> <small>RP</small></div></div>
          <div class="stat"><div class="k">RP / sec</div><div class="v"><span id="rps">0</span> <small>RP/s</small></div></div>
          <div class="stat"><div class="k">Lifetime Coins</div><div class="v"><span id="life">0</span></div></div>
        </div>

        <div class="buttons">
          <button id="clickBtn">CLICK ( +1 )</button>
          <button id="experimentBtn">RUN EXPERIMENT</button>
          <button id="resetBtn" title="l√∂scht nur deinen lokalen Save">RESET</button>
        </div>

        <div class="hint" id="hintLine">
          Start ist langsam: erst Drohnen kaufen, dann Upgrades. RP kommt √ºber Experimente + sp√§ter RP-Lab.
        </div>

        <div class="twoCols" style="margin-top:12px;">
          <div>
            <h2>HANGAR</h2>
            <div class="hangar" id="hangar"></div>
            <div class="hint">Mehr Drohnen ‚Üí mehr Symbole. Ab gro√üen Zahlen wird es zu ‚ÄúxN‚Äù.</div>
          </div>
          <div>
            <h2>CONSOLE</h2>
            <div class="monoBox" id="log"></div>
            <div class="hint">Die Konsole wird automatisch gek√ºrzt/geleert, damit es nicht spammt.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Shop -->
      <div>
        <div class="panel">
          <h2>DRONES (PRODUCERS)</h2>
          <div class="hint">Preise steigen pro Kauf: <span class="tag">base * 1.15^owned</span></div>
          <div class="list" id="droneList"></div>
        </div>

        <div class="panel" style="margin-top:14px;">
          <h2>RESEARCH TECH (RP)</h2>
          <div class="hint">RP Upgrades sind langfristig und skalieren im Preis. Fokus: Drohnen-Power & Click-Multipliers.</div>
          <div class="list" id="techList"></div>
        </div>

        <div class="panel" style="margin-top:14px;">
          <h2>COSMETICS</h2>
          <div class="hint">Themes sind wechselbar.</div>
          <div class="list" id="cosList"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const SAVE_KEY = "aenesche_ai_drone_clicker_v121";

  // ---------- BALANCE ----------
  const PRICE_GROWTH = 1.15;
  const TICK_MS = 200;

  const EXPERIMENT_CD_MS = 12000;

  // Console
  const MAX_LOG_LINES = 1000;
  const SOFT_CLEAR_MS = 600000;

  // Drones
  const DRONES = [
  { id:"temu",     name:"Temu Drone",     icon:"t", baseCps:0.10, basePrice:15,    unlock:{type:"always"} },
  { id:"amazon",   name:"Amazon Drone",   icon:"a", baseCps:1.00, basePrice:120,   unlock:{type:"owned", id:"temu", n:10} },
  { id:"fpv",      name:"FPV Drone",      icon:"f", baseCps:8.00, basePrice:1100,  unlock:{type:"owned", id:"amazon", n:8} },
  { id:"air3s",    name:"DJI Air 3S",     icon:"D", baseCps:47.0, basePrice:12000, unlock:{type:"owned", id:"fpv", n:8} },
  { id:"cine",     name:"Cinelifter",     icon:"C", baseCps:260,  basePrice:130000,unlock:{type:"owned", id:"air3s", n:6} },
  { id:"matrice",  name:"DJI Matrice",    icon:"M", baseCps:1400, basePrice:1500000, unlock:{type:"owned", id:"cine", n:10} },

  // üî• NEW ‚Äî Slightly steeper scaling via higher base
  { id:"titan", name:"Titan Strike Drone", icon:"T",
    baseCps:11000,
    basePrice:100_000_000,
    unlock:{type:"owned", id:"matrice", n:20}
  },

  { id:"leviathan", name:"Leviathan War Drone", icon:"L",
    baseCps:180000,
    basePrice:20_000_000_000,
    unlock:{type:"owned", id:"titan", n:15}
  }
];

  function droneUpgradeCost(droneBasePrice, level){
    const base = droneBasePrice * 12;
    return Math.floor(base * Math.pow(2.6, level));
  }

  // TECH (RP)
  const TECH = [
    { id:"globalCps", name:"Optimization Pass", desc:"+5% global CPS (repeatable)", type:"repeat", baseCost:6, growth:1.35 },
    { id:"droneBoost", name:"Drone Firmware", desc:"+6% drone CPS (repeatable)", type:"repeat", baseCost:10, growth:1.38 },

    // ‚úÖ Change: Click doubles per level
    { id:"clickBoost", name:"Quantization Trick", desc:"x2 click power (repeatable)", type:"repeat", baseCost:10, growth:1.42 },

    { id:"rpLab", name:"Research Lab", desc:"Unlock: buy RP-Lab producer (1-time)", type:"one", baseCost:25, growth:1.0,
      apply:(s)=>{ s.flags.rpLabUnlocked = true; } },
    { id:"rpLabBoost", name:"Lab Instrumentation", desc:"+25% RP-Lab output (repeatable)", type:"repeat", baseCost:18, growth:1.45 },
  ];

  const RP_LAB = { id:"rplab", name:"RP-Lab", icon:"R", baseRps:0.04, basePrice:5000, priceGrowth:1.20 };

  // Cosmetics reworked:
  // - Default theme is neutral (no neon).
  // - Themes can be activated/switch anytime once owned.
  // - Scanlines is a toggle effect.
  const THEMES = [
  { id:"default",  name:"Theme: Default",   cost:0, unlockByDefault:true, accent:"#bdbdbd" },
  { id:"green",    name:"Theme: Neon Green",cost:1000, unlockByDefault:false, accent:"#00ff88" },
  { id:"amber",    name:"Theme: Amber Terminal",cost:25_000_000, unlockByDefault:false, accent:"#ffb000" },
  { id:"ice",      name:"Theme: Ice Blue",  cost:60_000_000, unlockByDefault:false, accent:"#66d9ff" },

  { id:"violet",   name:"Theme: Neon Violet", cost:8_000_000_000, unlockByDefault:false, accent:"#b300ff" },
  { id:"pink",     name:"Theme: Cyber Pink", cost:25_000_000_000, unlockByDefault:false, accent:"#ff2da6" },
  { id:"gold",     name:"Theme: Gold Terminal", cost:150_000_000_000, unlockByDefault:false, accent:"#ffd700" },
];
  const EFFECTS = [
  { id:"scanlines", name:"Effect: CRT Scanlines", cost:120_000_000, unlockByDefault:false },
  { id:"cheeta", name:"Effect: C.H.E.E.T.A.", cost:100_000_000_000_000, unlockByDefault:false }
];

  // ---------- DOM ----------
  const $ = (id) => document.getElementById(id);
  const el = {
    coins: $("coins"), cps: $("cps"), clickPow: $("clickPow"),
    rp: $("rp"), rps: $("rps"), life: $("life"),
    clickBtn: $("clickBtn"), experimentBtn: $("experimentBtn"), resetBtn: $("resetBtn"),
    droneList: $("droneList"), techList: $("techList"), cosList: $("cosList"),
    hangar: $("hangar"), log: $("log"),
    statusTag: $("statusTag"), hintLine: $("hintLine"),
  };

  const now = () => Date.now();
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  function fmt(n){
    n = Number(n) || 0;
    if (n < 1000) return String(Math.floor(n));
    const units = ["k","M","B","T","Qa","Qi"];
    let u = -1;
    while(n >= 1000 && u < units.length-1){ n/=1000; u++; }
    return (n < 10 ? n.toFixed(2) : n < 100 ? n.toFixed(1) : n.toFixed(0)) + units[u];
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function log(line, cls=""){
    const t = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.innerHTML = `[${t}] ${cls ? `<span class="${cls}">` : ""}${escapeHtml(line)}${cls ? `</span>` : ""}`;
    el.log.appendChild(div);
    while(el.log.childNodes.length > MAX_LOG_LINES){
      el.log.removeChild(el.log.firstChild);
    }
    el.log.scrollTop = el.log.scrollHeight;
  }

  function maybeSoftClear(){
    if(now() - state.lastConsoleClear >= SOFT_CLEAR_MS){
      el.log.innerHTML = "";
      state.lastConsoleClear = now();
      log("console cleared (auto)", "ok");
    }
  }

  // ---------- STATE ----------
  function defaultState(){
    const ownedThemes = Object.fromEntries(THEMES.map(t => [t.id, !!t.unlockByDefault]));
    const ownedEffects = Object.fromEntries(EFFECTS.map(e => [e.id, false]));

    return {
      coins: 0,
      lifetimeCoins: 0,
      rp: 0,

      owned: Object.fromEntries(DRONES.map(d => [d.id, 0])),
      dUp: Object.fromEntries(DRONES.map(d => [d.id, 0])),

      techLvl: Object.fromEntries(TECH.map(t => [t.id, 0])),
      techOwned: Object.fromEntries(TECH.map(t => [t.id, false])),

      rpLabOwned: 0,
      flags: { rpLabUnlocked:false, vipOwned:false },

      nextExperimentAt: 0,

      // cosmetics state
      cosmetics: {
        themesOwned: ownedThemes,
        effectsOwned: ownedEffects,
        activeThemeId: "default",
        effectsActive: { scanlines:false },
      },

      lastTick: now(),
      lastConsoleClear: now(),
      createdAt: now(),
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      const merged = { ...defaultState(), ...s };

      // ensure keys exist
      for(const d of DRONES){
        if(!(d.id in merged.owned)) merged.owned[d.id] = 0;
        if(!(d.id in merged.dUp)) merged.dUp[d.id] = 0;
      }
      for(const t of TECH){
        if(!(t.id in merged.techLvl)) merged.techLvl[t.id] = 0;
        if(!(t.id in merged.techOwned)) merged.techOwned[t.id] = false;
      }

      // cosmetics migrations
      merged.cosmetics = merged.cosmetics || defaultState().cosmetics;
      merged.cosmetics.themesOwned = merged.cosmetics.themesOwned || defaultState().cosmetics.themesOwned;
      merged.cosmetics.effectsOwned = merged.cosmetics.effectsOwned || defaultState().cosmetics.effectsOwned;
      merged.cosmetics.effectsActive = merged.cosmetics.effectsActive || { scanlines:false };
      if(!merged.cosmetics.activeThemeId) merged.cosmetics.activeThemeId = "default";

      // make sure default theme exists
      merged.cosmetics.themesOwned.default = true;

      return merged;
    } catch {
      return defaultState();
    }
  }

  function save(){
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    el.statusTag.textContent = "autosave: ON";
  }

  // ---------- THEME + EFFECTS ----------
  function applyCosmetics(){
    // theme
    const activeTheme = THEMES.find(t => t.id === state.cosmetics.activeThemeId) || THEMES[0];
    document.documentElement.style.setProperty("--accent", activeTheme.accent);

    // scanlines effect
    const id = "scanlines-style";
    let tag = document.getElementById(id);

    const enabled = !!state.cosmetics.effectsActive.scanlines;
    if(enabled){
      if(!tag){
        tag = document.createElement("style");
        tag.id = id;

        // iOS/Safari friendly scanlines: simple low-alpha overlay (no blend mode)
        tag.textContent = `
          body:before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.08),
    rgba(255,255,255,0.08) 1px,
    rgba(0,0,0,0) 3px,
    rgba(0,0,0,0) 6px
  );
  opacity: .65;
}
body:after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 50% 40%, rgba(255,255,255,0.06), rgba(0,0,0,0) 60%),
    linear-gradient(to bottom, rgba(255,255,255,0.03), rgba(0,0,0,0.06));
  opacity:.45;
  animation: crtFlicker 2.8s infinite steps(2,end);
}
@keyframes crtFlicker{
  0%, 100%{ opacity:.40; }
  50%{ opacity:.52; }
}
        `;
        document.head.appendChild(tag);
      }
    } else {
      if(tag) tag.remove();
    }
  }

  // ---------- UNLOCKS ----------
  function isUnlocked(u){
    if(u.type === "always") return true;
    if(u.type === "owned"){
      return (state.owned[u.id] || 0) >= u.n;
    }
    return false;
  }

  // ---------- ECONOMY ----------
  function dronePrice(drone){
    const n = state.owned[drone.id] || 0;
    return Math.floor(drone.basePrice * Math.pow(PRICE_GROWTH, n));
  }

  function rpLabPrice(){
    const n = state.rpLabOwned || 0;
    return Math.floor(RP_LAB.basePrice * Math.pow(RP_LAB.priceGrowth, n));
  }

  function droneMultiplier(droneId){
    const lvl = state.dUp[droneId] || 0;
    return Math.pow(2, lvl);
  }

  function globalCpsMultiplier(){
    const lvl = state.techLvl.globalCps || 0;
    return Math.pow(1.05, lvl);
  }

  function droneCpsMultiplier(){
    const lvl = state.techLvl.droneBoost || 0;
    return Math.pow(1.06, lvl);
  }

  function clickMultiplier(){
    // ‚úÖ doubles per tech level
    const lvl = state.techLvl.clickBoost || 0;
    return Math.pow(2, lvl);
  }

  function rpLabMultiplier(){
    const lvl = state.techLvl.rpLabBoost || 0;
    return Math.pow(1.25, lvl);
  }

  function clickPower(){
  let base = 1;

  // Temu milestone
  const temu = state.owned.temu || 0;
  const ms = Math.floor(temu / 25);
  base *= Math.pow(1.10, ms);

  // üî• MATRIX MILESTONES (Click only)
  const m = state.owned.matrice || 0;

  if(m >= 10) base *= 2;
  if(m >= 20) base *= 2;
  if(m >= 35) base *= 4;

  base *= clickMultiplier();
  return base;
}

  function coinsPerSecond(){
    let cps = 0;
    for(const d of DRONES){
      const owned = state.owned[d.id] || 0;
      if(owned <= 0) continue;
      cps += owned * d.baseCps * droneMultiplier(d.id);
    }
    cps *= droneCpsMultiplier();
    cps *= globalCpsMultiplier();
    return cps;
  }

  function rpPerSecond(){
    if(!state.flags.rpLabUnlocked) return 0;
    const owned = state.rpLabOwned || 0;
    if(owned <= 0) return 0;
    return owned * RP_LAB.baseRps * rpLabMultiplier();
  }

  function addCoins(x){
    if(x <= 0) return;
    state.coins += x;
    state.lifetimeCoins += x;
  }

  // ---------- ACTIONS ----------
  function doClick(){
    const p = clickPower();
    addCoins(p);
    log(`click +${fmt(p)} CP`);
  }

  function buyDrone(drone){
    const unlocked = isUnlocked(drone.unlock);
    if(!unlocked){
      log(`locked: ${drone.name}`, "bad");
      return;
    }
    const cost = dronePrice(drone);
    if(state.coins < cost){
      log(`need ${fmt(cost)} CP for ${drone.name}`, "bad");
      return;
    }
    state.coins -= cost;
    state.owned[drone.id] = (state.owned[drone.id] || 0) + 1;
    log(`bought ${drone.name}`, "ok");
  }

  function buyDroneUpgrade(drone){
    const lvl = state.dUp[drone.id] || 0;
    const cost = droneUpgradeCost(drone.basePrice, lvl);
    if((state.owned[drone.id] || 0) <= 0){
      log(`buy the drone first: ${drone.name}`, "bad");
      return;
    }
    if(state.coins < cost){
      log(`need ${fmt(cost)} CP for ${drone.name} upgrade`, "bad");
      return;
    }
    state.coins -= cost;
    state.dUp[drone.id] = lvl + 1;
    log(`${drone.name} upgrade ‚Üí level ${lvl+1} (x2)`, "ok");
  }

  function techCost(t){
    if(t.type === "one"){
      return t.baseCost;
    }
    const lvl = state.techLvl[t.id] || 0;
    return Math.floor(t.baseCost * Math.pow(t.growth, lvl));
  }

  function buyTech(t){
    if(t.type === "one" && state.techOwned[t.id]){
      log(`already owned: ${t.name}`, "bad");
      return;
    }
    const cost = techCost(t);
    if(state.rp < cost){
      log(`need ${cost} RP for ${t.name}`, "bad");
      return;
    }
    state.rp -= cost;

    if(t.type === "one"){
      state.techOwned[t.id] = true;
      if(t.apply) t.apply(state);
      log(`tech unlocked: ${t.name}`, "ok");
    } else {
      state.techLvl[t.id] = (state.techLvl[t.id] || 0) + 1;
      log(`tech upgraded: ${t.name} (lvl ${state.techLvl[t.id]})`, "ok");
    }
  }

  function buyRpLab(){
    if(!state.flags.rpLabUnlocked){
      log("RP-Lab locked (buy Research Lab tech first)", "bad");
      return;
    }
    const cost = rpLabPrice();
    if(state.coins < cost){
      log(`need ${fmt(cost)} CP for RP-Lab`, "bad");
      return;
    }
    state.coins -= cost;
    state.rpLabOwned += 1;
    log(`bought RP-Lab`, "ok");
  }

  function runExperiment(){
    const t = now();
    if(t < state.nextExperimentAt){
      const left = Math.ceil((state.nextExperimentAt - t)/1000);
      log(`experiment cooling down (${left}s)`, "bad");
      return;
    }
    const gain = 1 + Math.floor(Math.log10(1 + state.lifetimeCoins) * 0.7);
    state.rp += gain;
    state.nextExperimentAt = t + EXPERIMENT_CD_MS;
    log(`experiment complete: +${gain} RP`, "ok");
  }

  // Cosmetics: buy/activate/toggle
  function buyTheme(theme){
    if(state.cosmetics.themesOwned[theme.id]){
      log(`already owned: ${theme.name}`, "bad");
      return;
    }
    if(state.coins < theme.cost){
      log(`need ${fmt(theme.cost)} CP for ${theme.name}`, "bad");
      return;
    }
    state.coins -= theme.cost;
    state.cosmetics.themesOwned[theme.id] = true;
    log(`unlocked: ${theme.name}`, "ok");
  }

  function activateTheme(themeId){
    if(!state.cosmetics.themesOwned[themeId]){
      log("theme not owned", "bad");
      return;
    }
    state.cosmetics.activeThemeId = themeId;
    applyCosmetics();
    log(`theme active: ${THEMES.find(t=>t.id===themeId)?.name || themeId}`, "ok");
  }

  function buyEffect(effect){
    if(state.cosmetics.effectsOwned[effect.id]){
      log(`already owned: ${effect.name}`, "bad");
      return;
    }
    if(state.coins < effect.cost){
      log(`need ${fmt(effect.cost)} CP for ${effect.name}`, "bad");
      return;
    }
    state.coins -= effect.cost;
    state.cosmetics.effectsOwned[effect.id] = true;
    log(`unlocked: ${effect.name}`, "ok");
  }

  function toggleEffect(effectId){

  if(!state.cosmetics.effectsOwned[effectId]){
    log("effect not owned", "bad");
    return;
  }

  if(effectId === "cheeta"){
    log("C.H.E.E.T.A. protocol engaged.", "bad");
    resetAll();
    return;
  }

  state.cosmetics.effectsActive[effectId] = !state.cosmetics.effectsActive[effectId];
  applyCosmetics();
  log(`effect ${effectId}: ${state.cosmetics.effectsActive[effectId] ? "ON" : "OFF"}`, "ok");
}

  // ---------- UI BUILD (drones hidden until unlocked) ----------
  const droneRows = new Map();
  const techRows = new Map();
  const cosRows = new Map();

  function ensureDroneRow(drone){
    if(droneRows.has(drone.id)) return;

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="itemTop">
        <div class="itemName">${drone.name}</div>
        <div class="itemMeta" id="dm_${drone.id}"></div>
      </div>
      <div class="itemMeta" style="margin-top:6px;" id="ds_${drone.id}"></div>
      <div class="itemBtns">
        <button class="mini" id="buy_${drone.id}">BUY</button>
        <button class="mini" id="up_${drone.id}">UPGRADE x2</button>
      </div>
    `;
    el.droneList.appendChild(row);

    const meta = row.querySelector(`#dm_${drone.id}`);
    const stats = row.querySelector(`#ds_${drone.id}`);
    const buy = row.querySelector(`#buy_${drone.id}`);
    const up = row.querySelector(`#up_${drone.id}`);

    buy.addEventListener("click", ()=>{ buyDrone(drone); render(); });
    up.addEventListener("click", ()=>{ buyDroneUpgrade(drone); render(); });

    droneRows.set(drone.id, { meta, stats, buy, up });

    log(`unlocked: ${drone.name}`, "ok");
  }

  function buildTechList(){
    el.techList.innerHTML = "";

    // RP-Lab purchase entry
    const rpLabRow = document.createElement("div");
    rpLabRow.className = "item";
    rpLabRow.innerHTML = `
      <div class="itemTop">
        <div class="itemName">RP-Lab (Producer)</div>
        <div class="itemMeta" id="rpl_meta"></div>
      </div>
      <div class="itemMeta" style="margin-top:6px;" id="rpl_stats"></div>
      <div class="itemBtns">
        <button class="mini" id="rpl_buy">BUY</button>
      </div>
    `;
    el.techList.appendChild(rpLabRow);
    const rpl = {
      meta: rpLabRow.querySelector("#rpl_meta"),
      stats: rpLabRow.querySelector("#rpl_stats"),
      buy: rpLabRow.querySelector("#rpl_buy")
    };
    rpl.buy.addEventListener("click", ()=>{ buyRpLab(); render(); });
    techRows.set("RPLAB_PRODUCER", rpl);

    // Tech entries
    for(const t of TECH){
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="itemTop">
          <div class="itemName">${t.name}</div>
          <div class="itemMeta" id="tm_${t.id}"></div>
        </div>
        <div class="itemMeta" style="margin-top:6px;">${t.desc}</div>
        <div class="itemBtns">
          <button class="mini" id="tb_${t.id}">BUY</button>
        </div>
      `;
      el.techList.appendChild(row);
      techRows.set(t.id, {
        meta: row.querySelector(`#tm_${t.id}`),
        buy: row.querySelector(`#tb_${t.id}`)
      });
      techRows.get(t.id).buy.addEventListener("click", ()=>{ buyTech(t); render(); });
    }
  }

  function buildCosmetics(){
    el.cosList.innerHTML = "";

    // Themes block
    const themeHeader = document.createElement("div");
    themeHeader.className = "item";
    themeHeader.innerHTML = `
      <div class="itemTop">
        <div class="itemName">THEMES</div>
        <div class="itemMeta">switch anytime</div>
      </div>
      <div class="itemMeta" style="margin-top:6px;">Default ist neutral. Neon Green ist der g√ºnstige Early-Upgrade.</div>
    `;
    el.cosList.appendChild(themeHeader);

    for(const th of THEMES){
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="itemTop">
          <div class="itemName">${th.name}</div>
          <div class="itemMeta" id="thm_${th.id}"></div>
        </div>
        <div class="itemMeta" style="margin-top:6px;">cost: ${fmt(th.cost)} CP</div>
        <div class="itemBtns">
          <button class="mini" id="thb_buy_${th.id}">BUY</button>
          <button class="mini" id="thb_act_${th.id}">ACTIVATE</button>
        </div>
      `;
      el.cosList.appendChild(row);

      const meta = row.querySelector(`#thm_${th.id}`);
      const buy = row.querySelector(`#thb_buy_${th.id}`);
      const act = row.querySelector(`#thb_act_${th.id}`);

      buy.addEventListener("click", ()=>{ buyTheme(th); render(); });
      act.addEventListener("click", ()=>{ activateTheme(th.id); render(); });

      cosRows.set(`theme_${th.id}`, { meta, buy, act });
    }
    const VIP_COST = 75_000_000_000;

const vipRow = document.createElement("div");
vipRow.className = "item";
vipRow.innerHTML = `
  <div class="itemTop">
    <div class="itemName">VIP Badge</div>
    <div class="itemMeta">Cosmetic</div>
  </div>
  <div class="itemMeta" style="margin-top:6px;">Pure flex.</div>
  <div class="itemBtns">
    <button class="mini" id="vip_buy">BUY (${fmt(VIP_COST)} CP)</button>
  </div>
`;
el.cosList.appendChild(vipRow);

vipRow.querySelector("#vip_buy").addEventListener("click", ()=>{
  if(state.flags.vipOwned) return;
  if(state.coins < VIP_COST){
    log("Not enough CP for VIP", "bad");
    return;
  }
  state.coins -= VIP_COST;
  state.flags.vipOwned = true;
  log("VIP badge acquired.", "ok");
  render();
});
    // Effects block
    const effHeader = document.createElement("div");
    effHeader.className = "item";
    effHeader.style.marginTop = "10px";
    effHeader.innerHTML = `
      <div class="itemTop">
        <div class="itemName">EFFECTS</div>
        <div class="itemMeta">toggle</div>
      </div>
      <div class="itemMeta" style="margin-top:6px;">Effekte sind separat vom Theme.</div>
    `;
    el.cosList.appendChild(effHeader);

    for(const ef of EFFECTS){
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="itemTop">
          <div class="itemName">${ef.name}</div>
          <div class="itemMeta" id="efm_${ef.id}"></div>
        </div>
        <div class="itemMeta" style="margin-top:6px;">cost: ${fmt(ef.cost)} CP</div>
        <div class="itemBtns">
          <button class="mini" id="efb_buy_${ef.id}">BUY</button>
          <button class="mini" id="efb_tog_${ef.id}">TOGGLE</button>
        </div>
      `;
      el.cosList.appendChild(row);

      const meta = row.querySelector(`#efm_${ef.id}`);
      const buy = row.querySelector(`#efb_buy_${ef.id}`);
      const tog = row.querySelector(`#efb_tog_${ef.id}`);

      buy.addEventListener("click", ()=>{ buyEffect(ef); render(); });
      tog.addEventListener("click", ()=>{ toggleEffect(ef.id); render(); });

      cosRows.set(`effect_${ef.id}`, { meta, buy, tog });
    }
  }

  // ---------- HANGAR ----------
  function renderHangar(){
    const MAX_ICONS_PER_TYPE = 30;
    el.hangar.innerHTML = "";

    // Show only unlocked or owned types
    const visible = DRONES.filter(d => isUnlocked(d.unlock) || (state.owned[d.id] || 0) > 0);

    for(const d of visible){
      const owned = state.owned[d.id] || 0;

      const row = document.createElement("div");
      row.className = "hangarRow";

      const left = document.createElement("div");
      left.className = "hangarLeft";
      left.innerHTML = `
        <span class="icon">${d.icon}</span>
        <div>
          <div style="font-size:12px;">${d.name}</div>
          <div class="count">owned: x${owned}</div>
        </div>
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "10px";
      right.style.alignItems = "center";

      const icons = document.createElement("div");
      icons.style.display = "flex";
      icons.style.gap = "4px";
      icons.style.flexWrap = "wrap";
      icons.style.justifyContent = "flex-end";
      icons.style.maxWidth = "220px";

      if(owned <= MAX_ICONS_PER_TYPE){
        for(let i=0;i<owned;i++){
          const ic = document.createElement("span");
          ic.className = "icon";
          ic.textContent = d.icon;
          icons.appendChild(ic);
        }
      } else {
        const ic = document.createElement("span");
        ic.className = "icon";
        ic.textContent = d.icon;
        icons.appendChild(ic);
        const cnt = document.createElement("span");
        cnt.className = "count";
        cnt.textContent = `x${owned}`;
        icons.appendChild(cnt);
      }

      // unlock progress bar for the NEXT locked drone only (nice mystery)
      const nextLocked = DRONES.find(x => !isUnlocked(x.unlock));
      const unlockBar = document.createElement("div");
      unlockBar.className = "bar";
      const fill = document.createElement("div");
      unlockBar.appendChild(fill);

      if(nextLocked && nextLocked.unlock.type === "owned"){
        const have = state.owned[nextLocked.unlock.id] || 0;
        const prog = clamp(have / nextLocked.unlock.n, 0, 1);
        fill.style.width = `${Math.floor(prog*100)}%`;
      } else {
        fill.style.width = `100%`;
      }

      right.appendChild(unlockBar);
      right.appendChild(icons);

      row.appendChild(left);
      row.appendChild(right);
      el.hangar.appendChild(row);
    }
  }

  // ---------- UPDATE ROWS ----------
  function updateDroneRows(){
    // ensure rows exist only when unlocked
    for(const d of DRONES){
      if(isUnlocked(d.unlock)){
        ensureDroneRow(d);
      }
    }

    // update existing rows
    for(const [id, row] of droneRows.entries()){
      const d = DRONES.find(x => x.id === id);
      if(!d) continue;

      const owned = state.owned[d.id] || 0;
      const price = dronePrice(d);

      const upLvl = state.dUp[d.id] || 0;
      const upCost = droneUpgradeCost(d.basePrice, upLvl);

      const per = d.baseCps * droneMultiplier(d.id) * droneCpsMultiplier() * globalCpsMultiplier();

      row.meta.textContent = "unlocked";
      row.stats.textContent =
        `owned: x${owned} ¬∑ next: ${fmt(price)} CP ¬∑ output(each): ${per.toFixed(per<10?2:1)} CP/s ¬∑ upgrade lvl: ${upLvl} (cost ${fmt(upCost)} CP)`;

      row.buy.disabled = state.coins < price;
      row.up.disabled = (owned<=0) || state.coins < upCost;
    }
  }

  function updateTechRows(){
    // RP-lab producer entry
    const rpl = techRows.get("RPLAB_PRODUCER");
    const price = rpLabPrice();
    const unlocked = state.flags.rpLabUnlocked;
    rpl.meta.textContent = unlocked ? "unlocked" : "locked (buy Research Lab tech)";
    rpl.stats.textContent = `owned: x${state.rpLabOwned} ¬∑ next: ${fmt(price)} CP ¬∑ output(each): ${(RP_LAB.baseRps*rpLabMultiplier()).toFixed(3)} RP/s`;
    rpl.buy.disabled = !unlocked || state.coins < price;

    for(const t of TECH){
      const row = techRows.get(t.id);
      if(t.type === "one"){
        row.meta.textContent = state.techOwned[t.id] ? "owned" : `${t.baseCost} RP`;
        row.buy.disabled = state.techOwned[t.id] || state.rp < t.baseCost;
        row.buy.textContent = state.techOwned[t.id] ? "OWNED" : "BUY";
      } else {
        const lvl = state.techLvl[t.id] || 0;
        const cost = techCost(t);
        row.meta.textContent = `lvl ${lvl} ¬∑ cost ${cost} RP`;
        row.buy.disabled = state.rp < cost;
        row.buy.textContent = "BUY";
      }
    }
  }

  function updateCosRows(){
    // Themes
    for(const th of THEMES){
      const row = cosRows.get(`theme_${th.id}`);
      const owned = !!state.cosmetics.themesOwned[th.id];
      const active = state.cosmetics.activeThemeId === th.id;

      row.meta.textContent = active ? "active" : (owned ? "owned" : "locked");

      row.buy.disabled = owned || state.coins < th.cost;
      row.buy.textContent = owned ? "OWNED" : "BUY";

      row.act.disabled = !owned || active;
      row.act.textContent = active ? "ACTIVE" : "ACTIVATE";
    }

    // Effects
    for(const ef of EFFECTS){
      const row = cosRows.get(`effect_${ef.id}`);
      const owned = !!state.cosmetics.effectsOwned[ef.id];
      const on = !!state.cosmetics.effectsActive[ef.id];

      row.meta.textContent = on ? "on" : (owned ? "owned" : "locked");

      row.buy.disabled = owned || state.coins < ef.cost;
      row.buy.textContent = owned ? "OWNED" : "BUY";

      row.tog.disabled = !owned;
      row.tog.textContent = on ? "TURN OFF" : "TURN ON";
    }
  }

  // ---------- RENDER ----------
  function render(){
    const cps = coinsPerSecond();
    const rps = rpPerSecond();
    const cp = clickPower();

    el.coins.textContent = fmt(state.coins);
    el.cps.textContent = cps.toFixed(cps<10?2:1);
    el.clickPow.textContent = cp.toFixed(cp<10?2:1);
    el.rp.textContent = fmt(state.rp);
    el.rps.textContent = rps.toFixed(3);
    el.life.textContent = fmt(state.lifetimeCoins);

    el.clickBtn.textContent = `CLICK ( +${cp.toFixed(cp<10?2:1)} )`;

    const t = now();
    const left = Math.max(0, state.nextExperimentAt - t);
    if(left > 0){
      el.experimentBtn.textContent = `RUN EXPERIMENT (${Math.ceil(left/1000)}s)`;
      el.experimentBtn.disabled = true;
    } else {
      el.experimentBtn.textContent = `RUN EXPERIMENT`;
      el.experimentBtn.disabled = false;
    }

    // hint: show only the NEXT unlock (keeps mystery)
    const next = DRONES.find(d => !isUnlocked(d.unlock));
    if(next && next.unlock.type === "owned"){
      const have = state.owned[next.unlock.id] || 0;
      el.hintLine.innerHTML =
        `Next unlock progress: <span class="tag">${have}/${next.unlock.n}</span> of <span class="tag">${next.unlock.id}</span>.`;
    } else {
      el.hintLine.textContent = "All drones unlocked. Now scale upgrades + RP tech + cosmetics.";
    }
        const vipBadge = document.getElementById("vipBadge");
    if(vipBadge){
      vipBadge.style.display = state.flags.vipOwned ? "inline" : "none";
    }
    
    updateDroneRows();
    updateTechRows();
    updateCosRows();
    renderHangar();
  }

  // ---------- TICK ----------
  function tick(){
    maybeSoftClear();

    const t = now();
    const dt = (t - state.lastTick) / 1000;
    state.lastTick = t;

    const cps = coinsPerSecond();
    if(cps > 0) addCoins(cps * dt);

    const rps = rpPerSecond();
    if(rps > 0) state.rp += rps * dt;

    render();
  }

  // ---------- RESET ----------
  function resetAll(){
    localStorage.removeItem(SAVE_KEY);
    state = defaultState();
    applyCosmetics();
    boot();
    render();
    save();
  }

  function boot(){
    el.log.innerHTML = "";
    log("boot: AI DRONE CLICKER v1.21", "ok");
    log("cosmetics: themes switchable + effects togglable", "ok");
    log("click tech now doubles per level", "ok");
    log("locked drones are hidden until unlocked", "ok");
  }

  // ---------- INIT ----------
  let state = load();
  applyCosmetics();

  // build panels that are always present
  buildTechList();
  buildCosmetics();

  // Inputs
  el.clickBtn.addEventListener("click", ()=>{ doClick(); render(); });
  el.experimentBtn.addEventListener("click", ()=>{ runExperiment(); render(); });
  el.resetBtn.addEventListener("click", ()=>{
    const ok = confirm("Reset? (l√∂scht nur dein lokales Savegame)");
    if(ok) resetAll();
  });

  // Autosave
  setInterval(save, 5000);
  window.addEventListener("beforeunload", save);

  boot();
  render();
  save();
  setInterval(tick, TICK_MS);
})();
</script>
</body>
</html>
