<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AENESCHE AI DRONE LAB</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#0f0f0f;
      --text:#eaeaea;
      --muted:#7a7a7a;
      --line:#1f1f1f;
      --accent:#00ff88;
      --warn:#ff4444;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      letter-spacing: .2px;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 64px;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      padding-bottom:12px;
      margin-bottom:16px;
    }
    .title{
      font-size: 16px;
      line-height: 1.2;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .row{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 860px){
      .row{ grid-template-columns: 1fr; }
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      padding:14px;
    }
    .panel h2{
      margin:0 0 10px;
      font-size:13px;
      color:var(--accent);
      font-weight:600;
      letter-spacing:.6px;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .stat{
      border:1px solid var(--line);
      padding:10px;
      background:#0b0b0b;
    }
    .k{ color:var(--muted); font-size:11px; margin-bottom:6px; }
    .v{ font-size:16px; }
    .v small{ color:var(--muted); font-size:12px; }

    .buttons{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      appearance:none;
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      padding:10px 12px;
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
      letter-spacing:.3px;
    }
    button:hover{ border-color:var(--accent); color:var(--accent); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      border-color:var(--line);
      color:var(--muted);
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.35;
    }
    .mono{
      border:1px solid var(--line);
      background:#050505;
      padding:10px;
      font-size:12px;
      white-space:pre-wrap;
      min-height:180px;
      max-height:260px;
      overflow:auto;
    }
    .ok{ color:var(--accent); }
    .bad{ color:var(--warn); }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .tag{
      display:inline-block;
      border:1px solid var(--line);
      padding:3px 6px;
      font-size:11px;
      color:var(--muted);
      margin-right:6px;
    }
    .footer{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .item{
      border:1px solid var(--line);
      background:#0b0b0b;
      padding:10px;
    }
    .itemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    .itemName{ font-size:12px; color:var(--text); }
    .itemMeta{ font-size:11px; color:var(--muted); }
    .itemBtns{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini{
      padding:7px 10px;
      font-size:11px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">AENESCHE AI DRONE LAB</div>
        <div class="sub">Compute → GPU → Train Model → Deploy Drone → Research</div>
      </div>
      <div class="sub">
        <span class="tag" id="statusTag">autosave: ON</span>
        <a href="/">home</a>
      </div>
    </div>

    <div class="row">
      <!-- LEFT -->
      <div class="panel">
        <h2>STATUS</h2>
        <div class="stats">
          <div class="stat">
            <div class="k">Compute</div>
            <div class="v"><span id="compute">0</span> <small>CU</small></div>
          </div>
          <div class="stat">
            <div class="k">Research</div>
            <div class="v"><span id="research">0</span> <small>RP</small></div>
          </div>
          <div class="stat">
            <div class="k">AI Level</div>
            <div class="v"><span id="aiLevel">1</span></div>
          </div>
          <div class="stat">
            <div class="k">Loss</div>
            <div class="v"><span id="loss">1.000</span></div>
          </div>
          <div class="stat">
            <div class="k">Compute / sec</div>
            <div class="v"><span id="cps">0</span> <small>CU/s</small></div>
          </div>
          <div class="stat">
            <div class="k">Drone Success</div>
            <div class="v"><span id="success">0</span><small>%</small></div>
          </div>
        </div>

        <div class="buttons">
          <button id="trainBtn">TRAIN STEP</button>
          <button id="deployBtn">DEPLOY DRONE</button>
          <button id="resetBtn" title="löscht nur deinen lokalen Save">RESET SAVE</button>
        </div>

        <div class="hint" id="hintLine"></div>

        <h2 style="margin-top:16px;">CONSOLE</h2>
        <div class="mono" id="log"></div>

        <div class="footer">
          <div>Save: <span id="saveInfo">—</span></div>
          <div>Build v0.2 · drones + RP</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="panel">
          <h2>GPU SYSTEM</h2>
          <div class="grid2">
            <div class="stat">
              <div class="k">Tier</div>
              <div class="v"><span id="gpuTierName">CPU</span></div>
            </div>
            <div class="stat">
              <div class="k">GPU Level</div>
              <div class="v"><span id="gpuLevel">0</span></div>
            </div>
          </div>
          <div class="hint" id="gpuDesc"></div>
          <div class="buttons">
            <button id="gpuUpBtn">UPGRADE GPU</button>
          </div>
        </div>

        <!-- DROHNE / UPGRADES PANEL (hier wolltest du es) -->
        <div class="panel" style="margin-top:16px;">
          <h2>DRONE HANGAR</h2>

          <div class="stat" style="margin-bottom:10px;">
            <div class="k">Selected Drone</div>
            <div class="v"><span id="droneName">—</span> <small id="droneTier">T1</small></div>
            <div class="k" style="margin-top:8px;">Mission</div>
            <div class="v" style="font-size:12px;color:var(--muted);line-height:1.35" id="droneInfo">—</div>
          </div>

          <div class="list" id="droneList"></div>

          <h2 style="margin-top:16px;">RESEARCH UPGRADES</h2>
          <div class="list" id="upgradeList"></div>

          <div class="hint">
            RP schaltet Drohnen + Upgrades frei. Click bleibt relevant: er skaliert mit AI+GPU.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY = "aenesche_ai_drone_lab_v021";

  const GPU_TIERS = [
    { name: "CPU",        baseCps: 0,    baseCost: 0 },
    { name: "GTX",        baseCps: 2.5,  baseCost: 60 },
    { name: "RTX",        baseCps: 12,   baseCost: 360 },
    { name: "CLUSTER",    baseCps: 55,   baseCost: 2400 },
    { name: "DATACENTER", baseCps: 260,  baseCost: 18000 },
  ];

  const DRONES = [
    { id:"temu",    tier:1, name:"Temu Drone",       unlockRP:0,   baseSuccess:70, durationMs:6500,  costBase:18,  rewardBase:65,  rpMin:1, rpMax:2, riskLossOnFail:0.02 },
    { id:"amazon",  tier:2, name:"Amazon Drone",     unlockRP:5,   baseSuccess:62, durationMs:7500,  costBase:40,  rewardBase:140, rpMin:1, rpMax:3, riskLossOnFail:0.03 },
    { id:"air3s",   tier:3, name:"DJI Air 3S",       unlockRP:20,  baseSuccess:56, durationMs:8500,  costBase:90,  rewardBase:280, rpMin:2, rpMax:4, riskLossOnFail:0.04 },
    { id:"cine",    tier:4, name:"FPV Cinelifter",   unlockRP:60,  baseSuccess:48, durationMs:9500,  costBase:170, rewardBase:520, rpMin:3, rpMax:6, riskLossOnFail:0.06 },
    { id:"matrice", tier:5, name:"DJI Matrice",      unlockRP:150, baseSuccess:42, durationMs:11000, costBase:320, rewardBase:980, rpMin:5, rpMax:9, riskLossOnFail:0.08 },
  ];

  const UPGRADES = [
    { id:"cooling",   name:"Cooling",          costRP:8,  desc:"+10% GPU compute",         apply:(s)=>s.bonusGpuMult=1.10 },
    { id:"dataset",   name:"Dataset++",        costRP:12, desc:"+15% click power",         apply:(s)=>s.bonusClickMult=1.15 },
    { id:"autonomy",  name:"Autonomy",         costRP:18, desc:"-15% mission time",        apply:(s)=>s.bonusMissionTimeMult=0.85 },
    { id:"frame",     name:"Reinforced Frame", costRP:25, desc:"fail penalty reduced",     apply:(s)=>s.bonusFailLossMult=0.65 },
  ];

  const $ = (id) => document.getElementById(id);
  const el = {
    compute: $("compute"),
    research: $("research"),
    aiLevel: $("aiLevel"),
    loss: $("loss"),
    cps: $("cps"),
    success: $("success"),
    log: $("log"),
    saveInfo: $("saveInfo"),
    statusTag: $("statusTag"),

    gpuTierName: $("gpuTierName"),
    gpuLevel: $("gpuLevel"),
    gpuDesc: $("gpuDesc"),

    droneName: $("droneName"),
    droneTier: $("droneTier"),
    droneInfo: $("droneInfo"),
    droneList: $("droneList"),
    upgradeList: $("upgradeList"),

    hintLine: $("hintLine"),

    trainBtn: $("trainBtn"),
    deployBtn: $("deployBtn"),
    gpuUpBtn: $("gpuUpBtn"),
    resetBtn: $("resetBtn"),
  };

  const now = () => Date.now();
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  function defaultState(){
    return {
      compute: 0,
      research: 0,
      aiLevel: 1,
      loss: 1.0,
      gpuTier: 0,
      gpuLevel: 0,

      selectedDroneId: "temu",
      purchasedUpgrades: {},

      bonusGpuMult: 1.0,
      bonusClickMult: 1.0,
      bonusMissionTimeMult: 1.0,
      bonusFailLossMult: 1.0,

      mission: { active:false, endsAt:0, startedAt:0, droneId:null },
      lastTick: now(),
      createdAt: now(),
      lastConsoleClear: now(),
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      return { ...defaultState(), ...s };
    } catch {
      return defaultState();
    }
  }

  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
    el.saveInfo.textContent = new Date().toLocaleTimeString();
  }

  function fmt(n){
    n = Number(n) || 0;
    if (n < 1000) return String(Math.floor(n));
    const units = ["k","M","B","T"];
    let u = -1;
    while(n >= 1000 && u < units.length-1){ n/=1000; u++; }
    return (n < 10 ? n.toFixed(2) : n < 100 ? n.toFixed(1) : n.toFixed(0)) + units[u];
  }

  // ---------- CONSOLE ----------
  const MAX_LOG_LINES = 60;
  const SOFT_CLEAR_MS = 90_000;

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function log(line, cls=""){
    const t = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.innerHTML = `[${t}] ${cls ? `<span class="${cls}">` : ""}${escapeHtml(line)}${cls ? `</span>` : ""}`;
    el.log.appendChild(div);
    while(el.log.childNodes.length > MAX_LOG_LINES){
      el.log.removeChild(el.log.firstChild);
    }
    el.log.scrollTop = el.log.scrollHeight;
  }

  function maybeSoftClear(){
    if(now() - state.lastConsoleClear >= SOFT_CLEAR_MS){
      el.log.innerHTML = "";
      state.lastConsoleClear = now();
      log("console cleared (auto)", "ok");
    }
  }

  // ---------- HELPERS ----------
  function getDrone(id){
    return DRONES.find(d => d.id === id) || DRONES[0];
  }
  function unlocked(drone){
    return state.research >= drone.unlockRP;
  }

  // ---------- BONUSES ----------
  function recomputeBonuses(){
    state.bonusGpuMult = 1.0;
    state.bonusClickMult = 1.0;
    state.bonusMissionTimeMult = 1.0;
    state.bonusFailLossMult = 1.0;

    for(const up of UPGRADES){
      if(state.purchasedUpgrades[up.id]){
        up.apply(state);
      }
    }
  }

  // ---------- GPU ----------
  function gpuCps(){
    const tier = GPU_TIERS[state.gpuTier];
    const mult = Math.pow(1.15, state.gpuLevel);
    return tier.baseCps * mult * state.bonusGpuMult;
  }

  function gpuUpgradeCost(){
    const nextTier = (state.gpuTier === 0) ? 1 : state.gpuTier;
    const tier = GPU_TIERS[nextTier];
    const level = (state.gpuTier === 0) ? 0 : (state.gpuLevel + 1);
    return tier.baseCost * Math.pow(1.18, level);
  }

  function maybeTierUp(){
    const thresholds = [0, 0, 10, 20, 32];
    if(state.gpuTier < GPU_TIERS.length - 1 && state.gpuLevel >= thresholds[state.gpuTier + 1]){
      state.gpuTier += 1;
      log(`GPU TIER UPGRADE → ${GPU_TIERS[state.gpuTier].name}`, "ok");
    }
  }

  function upgradeGpu(){
    const cost = gpuUpgradeCost();
    if(state.compute < cost){
      log(`GPU upgrade needs ${fmt(cost)} CU`, "bad");
      return;
    }
    state.compute -= cost;

    if(state.gpuTier === 0){
      state.gpuTier = 1;
      state.gpuLevel = 0;
      log(`GPU ONLINE → ${GPU_TIERS[state.gpuTier].name}`, "ok");
    } else {
      state.gpuLevel += 1;
      maybeTierUp();
      log(`GPU upgraded → level ${state.gpuLevel}`, "ok");
    }
  }

  // ---------- CLICK / TRAIN ----------
  function clickPower(){
    const ai = state.aiLevel;
    const gpu = state.gpuTier;
    const rp = state.research;
    const base = 1 + ai * 0.55 + gpu * 2.0;
    const rpBonus = 1 + Math.min(0.25, rp * 0.005);
    return base * rpBonus * state.bonusClickMult;
  }

  function trainStep(){
    const gain = clickPower();
    const cost = Math.max(0, (state.aiLevel - 1) * 0.20);
    if(state.compute < cost){
      log(`TRAIN aborted: need ${fmt(cost)} CU`, "bad");
      return;
    }
    state.compute -= cost;
    state.compute += gain;

    const delta = 0.018 / (1 + state.aiLevel * 0.10);
    state.loss = clamp(state.loss - delta, 0.05, 1.0);

    const target = Math.max(0.07, 0.95 / (1 + state.aiLevel * 0.30));
    if(state.loss <= target){
      state.aiLevel += 1;
      state.loss = clamp(state.loss + 0.07, 0.05, 1.0);
      log(`MODEL LEVEL UP → L${state.aiLevel}`, "ok");
    } else {
      log(`train: +${fmt(gain)} CU, loss -${delta.toFixed(4)}`);
    }
  }

  // ---------- DRONES (FIXED COST + NO REFUND ON FAIL) ----------
  function successChance(drone){
    const aiBoost = state.aiLevel * 3.2;
    const lossPenalty = state.loss * 38;
    const gpuBonus = Math.log10(1 + gpuCps()) * 7;
    let s = drone.baseSuccess + aiBoost - lossPenalty + gpuBonus;
    s -= (drone.tier - 1) * 2.0;
    return clamp(s, 25, 92);
  }

  function missionDuration(drone){
    return Math.round(drone.durationMs * state.bonusMissionTimeMult);
  }

  // ✅ FIX: cost no longer depends on AI or “attempts”
  function missionCost(drone){
    // stable per drone tier (small tier factor only)
    const tierMult = 1 + (drone.tier - 1) * 0.18;
    return Math.round(drone.costBase * tierMult);
  }

  function missionReward(drone){
    const ai = state.aiLevel;
    const gpu = gpuCps();
    const base = drone.rewardBase;
    const aiScale = 1 + Math.sqrt(ai) * 0.35;
    const gpuScale = 1 + Math.log10(1 + gpu) * 0.55;
    return base * aiScale * gpuScale;
  }

  function deployDrone(){
    if(state.mission.active){
      log("Mission already active.", "bad");
      return;
    }
    const drone = getDrone(state.selectedDroneId);
    if(!unlocked(drone)){
      log(`Locked: need ${drone.unlockRP} RP for ${drone.name}`, "bad");
      return;
    }

    const cost = missionCost(drone);
    if(state.compute < cost){
      log(`Need ${fmt(cost)} CU to deploy ${drone.name}.`, "bad");
      return;
    }

    state.compute -= cost;
    const dur = missionDuration(drone);
    state.mission = { active:true, startedAt: now(), endsAt: now() + dur, droneId: drone.id };
    log(`DEPLOY → ${drone.name} (cost ${fmt(cost)} CU). ETA ${Math.ceil(dur/1000)}s`, "ok");
  }

  function resolveMission(){
    const drone = getDrone(state.mission.droneId || state.selectedDroneId);
    const chance = successChance(drone);
    const roll = Math.random() * 100;

    if(roll <= chance){
      const rewardCU = missionReward(drone);
      const rp = Math.floor(clamp(
        drone.rpMin + (Math.random() * (drone.rpMax - drone.rpMin + 1)) + (state.aiLevel / 18),
        drone.rpMin, drone.rpMax + 2
      ));
      state.compute += rewardCU;
      state.research += rp;
      log(`SUCCESS → ${drone.name}: +${fmt(rewardCU)} CU, +${rp} RP`, "ok");
    } else {
      // ✅ FIX: no compute refund on fail
      const lossAdd = drone.riskLossOnFail * state.bonusFailLossMult;
      state.loss = clamp(state.loss + lossAdd, 0.05, 1.0);
      log(`FAIL → ${drone.name}: loss +${lossAdd.toFixed(2)} (no refund)`, "bad");
    }
  }

  // ---------- RP UPGRADES ----------
  function buyUpgrade(up){
    if(state.purchasedUpgrades[up.id]){
      log(`Upgrade already active: ${up.name}`, "bad");
      return;
    }
    if(state.research < up.costRP){
      log(`Need ${up.costRP} RP for ${up.name}`, "bad");
      return;
    }
    state.research -= up.costRP;
    state.purchasedUpgrades[up.id] = true;
    recomputeBonuses();
    log(`RESEARCH COMPLETE → ${up.name}`, "ok");
  }

  // ---------- BUILD LISTS ONCE (FIX BUTTONS) ----------
  const droneRowEls = new Map();
  const upgradeRowEls = new Map();

  function initDroneList(){
    el.droneList.innerHTML = "";
    for(const d of DRONES){
      const box = document.createElement("div");
      box.className = "item";
      box.innerHTML = `
        <div class="itemTop">
          <div class="itemName" id="dn_${d.id}">${d.name} <span style="color:var(--muted);font-size:11px;">(T${d.tier})</span></div>
          <div class="itemMeta" id="dm_${d.id}"></div>
        </div>
        <div class="itemMeta" style="margin-top:6px;" id="ds_${d.id}"></div>
        <div class="itemBtns">
          <button class="mini" id="db_${d.id}">SELECT</button>
        </div>
      `;
      el.droneList.appendChild(box);

      droneRowEls.set(d.id, {
        meta: box.querySelector(`#dm_${d.id}`),
        stats: box.querySelector(`#ds_${d.id}`),
        btn:  box.querySelector(`#db_${d.id}`),
      });

      droneRowEls.get(d.id).btn.addEventListener("click", () => {
        state.selectedDroneId = d.id;
        log(`Selected drone → ${getDrone(state.selectedDroneId).name}`, "ok");
        render();
      });
    }
  }

  function initUpgradeList(){
    el.upgradeList.innerHTML = "";
    for(const up of UPGRADES){
      const box = document.createElement("div");
      box.className = "item";
      box.innerHTML = `
        <div class="itemTop">
          <div class="itemName">${up.name}</div>
          <div class="itemMeta" id="um_${up.id}"></div>
        </div>
        <div class="itemMeta" style="margin-top:6px;">${up.desc}</div>
        <div class="itemBtns">
          <button class="mini" id="ub_${up.id}">BUY</button>
        </div>
      `;
      el.upgradeList.appendChild(box);

      upgradeRowEls.set(up.id, {
        meta: box.querySelector(`#um_${up.id}`),
        btn:  box.querySelector(`#ub_${up.id}`),
      });

      upgradeRowEls.get(up.id).btn.addEventListener("click", () => {
        buyUpgrade(up);
        render();
      });
    }
  }

  function updateDroneList(){
    for(const d of DRONES){
      const row = droneRowEls.get(d.id);
      const isUnlocked = unlocked(d);
      const isSelected = state.selectedDroneId === d.id;
      const chance = Math.round(successChance(d));
      const dur = Math.ceil(missionDuration(d)/1000);
      const cost = missionCost(d);

      row.meta.textContent = isUnlocked ? "unlocked" : `locked · ${d.unlockRP} RP`;
      row.stats.textContent = `success ~${chance}% · ETA ${dur}s · cost ${fmt(cost)} CU`;
      row.btn.disabled = !isUnlocked;
      row.btn.textContent = isSelected ? "SELECTED" : "SELECT";
    }
  }

  function updateUpgradeList(){
    for(const up of UPGRADES){
      const row = upgradeRowEls.get(up.id);
      const active = !!state.purchasedUpgrades[up.id];
      row.meta.textContent = active ? "active" : `${up.costRP} RP`;
      row.btn.disabled = active;
      row.btn.textContent = active ? "ACTIVE" : "BUY";
    }
  }

  // ---------- RENDER ----------
  function render(){
    recomputeBonuses();

    el.compute.textContent = fmt(state.compute);
    el.research.textContent = fmt(state.research);
    el.aiLevel.textContent = state.aiLevel;
    el.loss.textContent = state.loss.toFixed(3);

    const cps = gpuCps();
    el.cps.textContent = cps.toFixed(cps < 10 ? 2 : 1);

    const d = getDrone(state.selectedDroneId);
    el.droneName.textContent = d.name;
    el.droneTier.textContent = `T${d.tier}`;

    const chance = Math.round(successChance(d));
    el.success.textContent = chance;

    const dur = Math.ceil(missionDuration(d)/1000);
    const cost = missionCost(d);
    const reward = missionReward(d);

    el.droneInfo.textContent =
      `${unlocked(d) ? "unlocked" : `locked (${d.unlockRP} RP)`} · success ~${chance}% · ETA ${dur}s · cost ${fmt(cost)} CU · reward ~${fmt(reward)} CU`;

    el.gpuTierName.textContent = GPU_TIERS[state.gpuTier].name;
    el.gpuLevel.textContent = state.gpuLevel;

    const gpuCost = gpuUpgradeCost();
    const tierPreview = (state.gpuTier === 0) ? GPU_TIERS[1].name : GPU_TIERS[state.gpuTier].name;
    el.gpuDesc.textContent =
      `Next upgrade cost: ${fmt(gpuCost)} CU · Tier: ${tierPreview} · Passive: ${cps.toFixed(cps < 10 ? 2 : 1)} CU/s`;

    el.hintLine.innerHTML =
      `<span class="ok">TRAIN STEP</span> +${fmt(clickPower())} CU · ` +
      `<span class="ok">DEPLOY</span> nutzt die ausgewählte Drohne (Kosten jetzt stabil).`;

    // buttons + status tag
    if(state.mission.active){
      const left = Math.max(0, state.mission.endsAt - now());
      el.statusTag.textContent = `mission: ${Math.ceil(left/1000)}s`;
      el.statusTag.style.borderColor = "var(--accent)";
      el.statusTag.style.color = "var(--accent)";
      el.deployBtn.disabled = true;
      el.deployBtn.textContent = "MISSION IN PROGRESS…";
    } else {
      el.statusTag.textContent = "autosave: ON";
      el.statusTag.style.borderColor = "var(--line)";
      el.statusTag.style.color = "var(--muted)";
      el.deployBtn.disabled = false;
      el.deployBtn.textContent = "DEPLOY DRONE";
    }

    updateDroneList();
    updateUpgradeList();
  }

  // ---------- LOOP ----------
  function tick(){
    maybeSoftClear();
    const t = now();
    const dt = (t - state.lastTick) / 1000;
    state.lastTick = t;

    state.compute += gpuCps() * dt;

    if(state.mission.active && t >= state.mission.endsAt){
      state.mission.active = false;
      resolveMission();
    }

    render();
  }

  function resetSave(){
    localStorage.removeItem(KEY);
    state = defaultState();
    boot();
    render();
    save();
  }

  function boot(){
    el.log.innerHTML = "";
    log("boot: ai_drone_lab v0.21", "ok");
    log("fix: reliable buttons (no rerender spam)", "ok");
    log("fix: stable drone costs + no fail refunds", "ok");
    log("tip: Temu → farm RP → unlock Amazon/Air 3S", "ok");
  }

  // ---------- START ----------
  let state = load();
  recomputeBonuses();

  initDroneList();
  initUpgradeList();

  el.trainBtn.addEventListener("click", () => { trainStep(); render(); });
  el.deployBtn.addEventListener("click", () => { deployDrone(); render(); });
  el.gpuUpBtn.addEventListener("click", () => { upgradeGpu(); render(); });
  el.resetBtn.addEventListener("click", () => {
    const ok = confirm("Reset save? (löscht nur dein lokales Savegame)");
    if(ok) resetSave();
  });

  setInterval(save, 5000);
  window.addEventListener("beforeunload", save);

  boot();
  render();
  save();
  setInterval(tick, 200);
})();
</script>
</body>
</html>
